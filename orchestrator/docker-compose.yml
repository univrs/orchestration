# Docker Compose for AI-Native Orchestrator Multi-Node Testing
#
# This setup creates a 3-node cluster:
# - 1 Bootstrap node (seeds the cluster)
# - 2 Worker nodes (join via bootstrap)
#
# Usage:
#   docker-compose up -d          # Start all nodes
#   docker-compose logs -f        # Follow logs
#   docker-compose down           # Stop and remove
#
# Endpoints:
#   Bootstrap: http://localhost:9090 (health/metrics)
#   Worker 1:  http://localhost:9091 (health/metrics)
#   Worker 2:  http://localhost:9092 (health/metrics)

version: '3.8'

services:
  # Bootstrap node - seeds the cluster
  bootstrap:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: orchestrator-bootstrap
    hostname: bootstrap
    environment:
      - NODE_ID=00000000-0000-0000-0000-000000000001
      - NODE_ROLE=bootstrap
      - LISTEN_ADDR=0.0.0.0:7280
      - PUBLIC_ADDR=bootstrap:7280
      - API_PORT=9090
      - CLUSTER_ID=orchestrator-local
      - NODE_CPU=4.0
      - NODE_MEMORY_MB=4096
      - NODE_DISK_MB=51200
      - LOG_LEVEL=info
      - LOG_JSON=false
    ports:
      - "9090:9090"     # Health/metrics API
      - "7280:7280/udp" # Gossip port (exposed for debugging)
    networks:
      - orchestrator-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # Worker node 1
  worker1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: orchestrator-worker1
    hostname: worker1
    depends_on:
      bootstrap:
        condition: service_healthy
    environment:
      - NODE_ID=00000000-0000-0000-0000-000000000002
      - NODE_ROLE=worker
      - LISTEN_ADDR=0.0.0.0:7280
      - PUBLIC_ADDR=worker1:7280
      - SEED_NODES=bootstrap:7280
      - API_PORT=9090
      - CLUSTER_ID=orchestrator-local
      - NODE_CPU=2.0
      - NODE_MEMORY_MB=2048
      - NODE_DISK_MB=25600
      - LOG_LEVEL=info
      - LOG_JSON=false
    ports:
      - "9091:9090"     # Health/metrics API
    networks:
      - orchestrator-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Worker node 2
  worker2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: orchestrator-worker2
    hostname: worker2
    depends_on:
      bootstrap:
        condition: service_healthy
    environment:
      - NODE_ID=00000000-0000-0000-0000-000000000003
      - NODE_ROLE=worker
      - LISTEN_ADDR=0.0.0.0:7280
      - PUBLIC_ADDR=worker2:7280
      - SEED_NODES=bootstrap:7280
      - API_PORT=9090
      - CLUSTER_ID=orchestrator-local
      - NODE_CPU=2.0
      - NODE_MEMORY_MB=2048
      - NODE_DISK_MB=25600
      - LOG_LEVEL=info
      - LOG_JSON=false
    ports:
      - "9092:9090"     # Health/metrics API
    networks:
      - orchestrator-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

networks:
  orchestrator-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
